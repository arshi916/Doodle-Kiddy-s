<!-- views/admin/edit-product.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Product</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.95); }
    .hover-lift { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(101, 67, 33, 0.15); }
    .floating-label { position: relative; }
    .floating-label input:focus + label,
    .floating-label input:not(:placeholder-shown) + label,
    .floating-label select:focus + label,
    .floating-label textarea:focus + label,
    .floating-label textarea:not(:placeholder-shown) + label {
      transform: translateY(-24px) scale(0.85); color: #8B7355;
    }
    .floating-label label {
      position: absolute; left: 12px; top: 12px; background: white; padding: 0 4px;
      transition: all 0.2s ease; pointer-events: none; color: #6B7280;
    }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .gradient-border { background: linear-gradient(135deg, #8B7355 0%, #A0845C 100%); padding: 2px; border-radius: 12px; }
    .gradient-border-inner { background: white; border-radius: 10px; padding: 1rem; }
  </style>
</head>
<body class="bg-gradient-to-br from-stone-100 to-amber-50 min-h-screen">

<div class="flex h-screen">
  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-2xl border-r border-stone-300">
    <div class="p-6">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-gradient-to-r from-stone-600 to-amber-800 rounded-lg flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
          </svg>
        </div>
        <h2 class="text-xl font-bold bg-gradient-to-r from-stone-600 to-amber-800 bg-clip-text text-transparent">AdminHub</h2>
      </div>
    </div>
    <nav class="mt-2 px-4 space-y-1">
      <a href="/admin" class="flex items-center gap-3 py-3 px-4 text-gray-700 hover:bg-gradient-to-r hover:from-stone-100 hover:to-amber-50 hover:text-stone-700 rounded-xl transition-all duration-200 group">
        <svg class="w-5 h-5 text-stone-600 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6" />
        </svg>
        <span class="font-medium">Dashboard</span>
      </a>
      <a href="/admin/products" class="flex items-center gap-3 py-3 px-4 bg-gradient-to-r from-stone-200 to-amber-100 text-stone-800 rounded-xl shadow-sm">
        <svg class="w-5 h-5 text-stone-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M20 13V5a2 2 0 00-2-2H6a2 2 0 00-2 2v8m16 0H4m0 0v6a2 2 0 002 2h12a2 2 0 002-2v-6" />
        </svg>
        <span class="font-semibold">Products</span>
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col">
    <header class="glass-effect shadow-lg border-b border-stone-300 px-6 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-4">
          <a href="/admin/products" class="inline-flex items-center text-stone-600 hover:text-stone-800 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            Back to Products
          </a>
          <div class="h-6 w-px bg-stone-300"></div>
          <h1 class="text-2xl font-bold text-gray-800">Edit Product</h1>
        </div>
      </div>
    </header>

    <main class="p-6 overflow-auto flex-1 custom-scrollbar">
      <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl border border-stone-300 hover-lift">
        <div class="bg-gradient-to-r from-stone-100 to-amber-50 rounded-t-2xl p-6 border-b border-stone-300">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-r from-stone-600 to-amber-800 rounded-2xl flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
            </div>
            <div>
              <h2 class="text-xl font-bold text-gray-800">Product Information</h2>
              <p class="text-sm text-gray-600">Update product details and inventory</p>
            </div>
          </div>
        </div>

        <div class="p-8">
          <form id="productForm" action="/admin/products/update/<%= product._id %>" method="POST" enctype="multipart/form-data">
            <!-- Images Section -->
            <div class="mb-8">
              <div class="gradient-border">
                <div class="gradient-border-inner">
                  <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 bg-gradient-to-r from-stone-600 to-amber-800 rounded-lg flex items-center justify-center">
                      <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>
                    <div>
                      <h3 class="text-lg font-semibold text-gray-800">Product Images</h3>
                      <p class="text-sm text-gray-500">Current: <%= Array.isArray(product.productImage) ? product.productImage.length : 0 %> images (min 3, max 4)</p>
                    </div>
                  </div>

                  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-4">
                    <% 
                      const safeImages = Array.isArray(product.productImage) ? product.productImage : [];
                      for(let i = 0; i < 4; i++) { 
                    %>
                      <% if (i < safeImages.length) { %>
                        <div id="imageBox<%= i %>" class="aspect-square border-2 border-dashed border-stone-300 rounded-xl relative group overflow-hidden bg-stone-50/50">
                          <img src="/images/<%= safeImages[i] %>" class="w-full h-full object-cover rounded-xl" alt="Product image" />
                          <button type="button" 
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 text-sm hover:bg-red-600 transition-all hover:scale-110 shadow-lg opacity-0 group-hover:opacity-100" 
                            onclick="markForDelete(<%= i %>, event)">
                            ×
                          </button>
                        </div>
                      <% } else { %>
                        <div id="imageBox<%= i %>" class="aspect-square border-2 border-dashed border-stone-300 flex items-center justify-center rounded-xl cursor-pointer bg-stone-50/50 hover:bg-stone-100/50 hover:border-stone-600 transition-all duration-300 relative group" onclick="triggerImageUpload(<%= i %>)">
                          <span class="text-3xl text-stone-400 font-light group-hover:text-stone-600 transition-colors">+</span>
                          <img id="preview<%= i %>" class="w-full h-full object-cover rounded-xl hidden" />
                          <button id="delete<%= i %>" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 text-sm hover:bg-red-600 transition-all duration-200 hover:scale-110 shadow-lg hidden" type="button" onclick="deleteImage(<%= i %>, event)">×</button>
                        </div>
                      <% } %>
                    <% } %>
                  </div>

                  <% for(let i = 0; i < 4; i++) { %>
                    <input type="file" id="imageInput<%= i %>" accept="image/*" class="hidden" onchange="handleImageSelect(<%= i %>)">
                  <% } %>

                  <div id="imageError" class="text-red-500 text-sm mt-2 hidden flex items-center gap-2">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    <span></span>
                  </div>
                  <div id="imageCount" class="text-sm text-gray-600 mt-2">
                    Images: <span id="currentCount" class="font-medium text-stone-600"><%= safeImages.length %></span>/4
                  </div>
                </div>
              </div>
            </div>

            <!-- Product Details -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <div class="floating-label">
                <input id="productName" name="productName" value="<%= product.productName %>" required class="w-full p-4 border-2 border-stone-200 rounded-xl" placeholder=" " />
                <label class="font-medium">Product Name <span class="text-red-500">*</span></label>
              </div>
              <div class="floating-label">
                <select id="category" name="category" required class="w-full p-4 border-2 border-stone-200 rounded-xl bg-white">
                  <option value="" disabled <%= !product.category ? 'selected' : '' %>>-- Select Category --</option>
                  <% categories.forEach(cat => { %>
                    <option value="<%= cat._id %>" <%= product.category && product.category._id.toString() === cat._id.toString() ? 'selected' : '' %>><%= cat.name %></option>
                  <% }) %>
                </select>
                <label class="font-medium">Category <span class="text-red-500">*</span></label>
              </div>
            </div>

            <!-- Colors -->
            <div class="mb-8">
              <label class="block text-sm font-semibold text-gray-700 mb-3">Colors Available <span class="text-red-500">*</span></label>
              <div class="flex gap-3 flex-wrap" id="colorOptions">
                <% ['white','gray','beige','yellow','orange','red','purple','blue','green','black'].forEach(color => { %>
                  <button type="button" data-color="<%= color %>" class="color-btn flex items-center gap-2 px-4 py-2 border-2 rounded-xl transition-all duration-300 <%= product.color.includes(color) ? 'border-stone-600 bg-stone-100' : 'border-stone-200 bg-stone-50' %> hover:border-stone-600">
                    <span class="w-5 h-5 rounded-full <%= color === 'white' ? 'bg-white border-2 border-gray-300' : color === 'beige' ? 'bg-yellow-100' : 'bg-' + color + '-400' %> shadow-sm"></span>
                    <span class="font-medium"><%= color.charAt(0).toUpperCase() + color.slice(1) %></span>
                  </button>
                <% }) %>
              </div>
              <div id="colorError" class="text-red-500 text-sm mt-2 hidden flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                <span></span>
              </div>
            </div>

            <!-- Size & Stock Section -->
            <div id="colorSizeStockSection" class="mb-8"></div>

            <!-- Pricing & Status -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div class="floating-label">
                <input id="regularPrice" name="regularPrice" type="number" min="1" step="0.01" value="<%= product.regularPrice %>" required class="w-full p-4 border-2 border-stone-200 rounded-xl" placeholder=" " />
                <label class="font-medium">Regular Price (₹) <span class="text-red-500">*</span></label>
              </div>
              <div class="floating-label">
                <input id="salePrice" name="salePrice" type="number" min="1" step="0.01" value="<%= product.salePrice %>" required class="w-full p-4 border-2 border-stone-200 rounded-xl" placeholder=" " />
                <label class="font-medium">Sale Price (₹) <span class="text-red-500">*</span></label>
              </div>
              <div class="floating-label">
                <input id="quantity" type="number" readonly value="<%= product.quantity %>" class="w-full p-4 border-2 border-stone-200 rounded-xl bg-stone-50 cursor-not-allowed" />
                <label class="font-medium">Total Quantity (Auto)</label>
              </div>
              <div class="floating-label">
                <select name="status" class="w-full p-4 border-2 border-stone-200 rounded-xl bg-white">
                  <option value="Available" <%= product.status === 'Available' ? 'selected' : '' %>>Available</option>
                  <option value="out of stock" <%= product.status === 'out of stock' ? 'selected' : '' %>>Out of Stock</option>
                  <option value="Discontinued" <%= product.status === 'Discontinued' ? 'selected' : '' %>>Discontinued</option>
                </select>
                <label class="font-medium">Status</label>
              </div>
            </div>

            <!-- Return Policy -->
            <div class="mb-8">
              <label class="block text-sm font-semibold text-gray-700 mb-4">Return Policy</label>
              <div class="flex gap-6">
                <label class="flex items-center gap-3 cursor-pointer group">
                  <input type="radio" name="returnPolicy" value="false" <%= !product.returnPolicy ? 'checked' : '' %> class="w-4 h-4 text-stone-600 focus:ring-stone-500" />
                  <span class="flex items-center gap-2 font-medium text-gray-700 group-hover:text-stone-600 transition-colors">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    No Returns
                  </span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                  <input type="radio" name="returnPolicy" value="true" <%= product.returnPolicy ? 'checked' : '' %> class="w-4 h-4 text-stone-600 focus:ring-stone-500" />
                  <span class="flex items-center gap-2 font-medium text-gray-700 group-hover:text-stone-600 transition-colors">
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Returns Allowed
                  </span>
                </label>
              </div>
            </div>

            <!-- Description -->
            <div class="mb-8">
              <div class="floating-label">
                <textarea id="description" name="description" required class="w-full p-4 border-2 border-stone-200 rounded-xl focus:border-stone-600 focus:ring-4 focus:ring-stone-600/10 transition-all duration-300 placeholder-transparent h-32 resize-none bg-white" placeholder=" "><%- product.description %></textarea>
                <label class="font-medium">Description <span class="text-red-500">*</span></label>
              </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-end gap-4">
              <a href="/admin/products" class="px-6 py-3 bg-stone-200 text-stone-700 font-semibold rounded-xl hover:bg-stone-300 transition-all duration-300">Cancel</a>
              <button type="submit" id="submitBtn" class="group relative px-8 py-3 bg-gradient-to-r from-stone-600 to-amber-800 text-white font-semibold rounded-xl hover:from-stone-700 hover:to-amber-900 transition-all duration-300 transform hover:scale-105 hover:shadow-xl">
                <span class="relative z-10 flex items-center gap-3">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                  </svg>
                  Save Changes
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Crop Modal -->
<div id="cropModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-full mx-4 overflow-hidden">
    <div class="bg-gradient-to-r from-stone-600 to-amber-800 p-6">
      <h3 class="text-xl font-bold text-white">Crop Image</h3>
    </div>
    <div class="p-6">
      <div class="mb-6 bg-stone-50 rounded-2xl p-4">
        <img id="cropImage" style="max-width: 100%; height: 400px;">
      </div>
      <div class="flex justify-end gap-4">
        <button type="button" id="cancelCrop" class="px-6 py-3 bg-stone-100 text-stone-700 font-medium rounded-xl hover:bg-stone-200">Cancel</button>
        <button type="button" id="confirmCrop" class="px-6 py-3 bg-gradient-to-r from-stone-600 to-amber-800 text-white font-medium rounded-xl hover:from-stone-700 hover:to-amber-900">Crop & Save</button>
      </div>
    </div>
  </div>
</div>

<script>
let cropper = null;
let currentImageIndex = 0;
let uploadedFiles = [null, null, null, null];
let selectedColors = <%- JSON.stringify(product.color || []) %>;
let isSubmitting = false;

// Initialize existing images in uploadedFiles array
<% if (Array.isArray(product.productImage)) { 
  product.productImage.forEach((img, i) => { %>
    uploadedFiles[<%= i %>] = { name: '<%= img %>', existing: true };
<% }); } %>

function updateImageCount() {
  const count = uploadedFiles.filter(f => f !== null).length;
  document.getElementById('currentCount').textContent = count;
}

// Color selection toggle
// Valid sizes
const sizes = ["XS", "S", "M", "L", "XL"];


// Render size & stock table
function renderColorSizeStock() {
  const container = document.getElementById('colorSizeStockSection');
  container.innerHTML = '';

  if (selectedColors.length === 0) {
    container.innerHTML = '<p class="text-sm text-gray-500 italic">Select at least one color to manage sizes and stock.</p>';
    return;
  }

  let tableHTML = `
    <div class="mt-6 overflow-x-auto">
      <table class="min-w-full border border-stone-300 rounded-lg bg-white">
        <thead class="bg-stone-100">
          <tr>
            <th class="px-6 py-4 text-left font-semibold text-gray-700">Color</th>
            ${sizes.map(size => `<th class="px-6 py-4 text-center font-semibold text-gray-700">${size}</th>`).join('')}
            <th class="px-6 py-4 text-center font-semibold text-gray-700">Row Total</th>
          </tr>
        </thead>
        <tbody>
  `;

  const existingStocks = <%- JSON.stringify(product.stocks || []) %>;

  selectedColors.forEach(color => {
    let rowTotal = 0;

    tableHTML += `
      <tr class="border-b border-stone-200">
        <td class="px-6 py-4">
          <div class="flex items-center gap-3">
            <div class="w-6 h-6 rounded-full ${color === 'white' ? 'bg-white border-2 border-gray-300' : color === 'beige' ? 'bg-yellow-100' : 'bg-' + color + '-400'}"></div>
            <span class="font-medium capitalize">${color}</span>
          </div>
        </td>
    `;

    sizes.forEach(size => {
      const stock = existingStocks.find(s => s.color === color && s.size === size);
      const value = stock ? stock.quantity : 0;
      rowTotal += value;

      tableHTML += `
        <td class="px-6 py-4 text-center">
          <input type="number" name="stock_${color}_${size}" min="0" value="${value}"
                 class="w-24 px-3 py-2 border border-stone-300 rounded-lg focus:outline-none focus:border-stone-600 text-center"
                 placeholder="0">
        </td>
      `;
    });

    tableHTML += `
        <td class="px-6 py-4 text-center font-bold text-stone-700">${rowTotal}</td>
      </tr>
    `;
  });

  tableHTML += `
        </tbody>
      </table>
    </div>
    <input type="hidden" name="sizes" value="${sizes.join(',')}">
  `;

  container.innerHTML = tableHTML;

  // Live update row total
  selectedColors.forEach(color => {
    sizes.forEach(size => {
      const input = container.querySelector(`input[name="stock_${color}_${size}"]`);
      if (input) {
        input.addEventListener('input', () => {
          let total = 0;
          sizes.forEach(s => {
            const val = parseInt(container.querySelector(`input[name="stock_${color}_${s}"]`)?.value || 0);
            total += val;
          });
          input.closest('tr').querySelector('td:last-child').textContent = total;
        });
      }
    });
  });
}

// Color button toggle + re-render table
document.querySelectorAll('.color-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const color = this.dataset.color;
    const index = selectedColors.indexOf(color);

    if (index === -1) {
      selectedColors.push(color);
    } else {
      selectedColors.splice(index, 1);
    }

    // Visual feedback
    this.classList.toggle('border-stone-600', selectedColors.includes(color));
    this.classList.toggle('bg-stone-100', selectedColors.includes(color));
    this.classList.toggle('border-stone-200', !selectedColors.includes(color));
    this.classList.toggle('bg-stone-50', !selectedColors.includes(color));

    renderColorSizeStock();
  });
});

// Initial render
renderColorSizeStock();

// Image handling
function triggerImageUpload(index) {
  document.getElementById(`imageInput${index}`).click();
}

function handleImageSelect(index) {
  const input = document.getElementById(`imageInput${index}`);
  const file = input.files[0];
  if (!file) return;

  if (!file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    alert('Image must be less than 5MB');
    return;
  }

  currentImageIndex = index;
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('cropImage').src = e.target.result;
    document.getElementById('cropModal').classList.remove('hidden');

    if (cropper) cropper.destroy();
    cropper = new Cropper(document.getElementById('cropImage'), {
      aspectRatio: 1,
      viewMode: 1,
      dragMode: 'move',
      autoCropArea: 1
    });
  };
  reader.readAsDataURL(file);
}

function markForDelete(index, event) {
  event.stopPropagation();
  uploadedFiles[index] = null; // Mark as deleted

  const box = document.getElementById(`imageBox${index}`);
  box.innerHTML = `
    <span class="text-3xl text-stone-400 font-light group-hover:text-stone-600 transition-colors">+</span>
    <img id="preview${index}" class="w-full h-full object-cover rounded-xl hidden" />
    <button id="delete${index}" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 text-sm hover:bg-red-600 transition-all duration-200 hover:scale-110 shadow-lg hidden" type="button" onclick="deleteImage(${index}, event)">×</button>
  `;
  box.className = "aspect-square border-2 border-dashed border-stone-300 flex items-center justify-center rounded-xl cursor-pointer bg-stone-50/50 hover:bg-stone-100/50 hover:border-stone-600 transition-all duration-300 relative group";
  box.onclick = () => triggerImageUpload(index);

  updateImageCount();
}

function deleteImage(index, event) {
  event.stopPropagation();
  uploadedFiles[index] = null;
  document.getElementById(`imageInput${index}`).value = '';
  const box = document.getElementById(`imageBox${index}`);
  box.innerHTML = `
    <span class="text-3xl text-stone-400 font-light">+</span>
    <img id="preview${index}" class="w-full h-full object-cover rounded-xl hidden" />
    <button id="delete${index}" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-7 h-7 text-sm hover:bg-red-600 transition-all duration-200 hover:scale-110 shadow-lg hidden" type="button" onclick="deleteImage(${index}, event)">×</button>
  `;
  updateImageCount();
}

document.getElementById('cancelCrop').onclick = () => {
  document.getElementById('cropModal').classList.add('hidden');
  if (cropper) { cropper.destroy(); cropper = null; }
  document.getElementById(`imageInput${currentImageIndex}`).value = '';
};

document.getElementById('confirmCrop').onclick = () => {
  if (!cropper) return;
  const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
  canvas.toBlob(blob => {
    const file = new File([blob], `cropped-${currentImageIndex}.jpg`, { type: 'image/jpeg' });
    uploadedFiles[currentImageIndex] = file;

    const preview = document.getElementById(`preview${currentImageIndex}`);
    preview.src = URL.createObjectURL(file);
    preview.classList.remove('hidden');

    const plus = preview.previousElementSibling;
    if (plus && plus.tagName === 'SPAN') plus.classList.add('hidden');

    const deleteBtn = document.getElementById(`delete${currentImageIndex}`);
    deleteBtn.classList.remove('hidden');

    document.getElementById('cropModal').classList.add('hidden');
    if (cropper) { cropper.destroy(); cropper = null; }
    updateImageCount();
  }, 'image/jpeg', 0.9);
};

// Form submission
document.getElementById('productForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  if (isSubmitting) return;
  isSubmitting = true;

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="relative z-10">Saving...</span>';

  // Client-side validation
  const validImages = uploadedFiles.filter(f => f !== null).length;
  if (validImages < 3 || validImages > 4) {
    alert(validImages < 3 ? `Need at least 3 images (currently ${validImages})` : 'Maximum 4 images allowed');
    submitBtn.disabled = false;
    submitBtn.innerHTML = `<span class="relative z-10 flex items-center gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Save Changes</span>`;
    isSubmitting = false;
    return;
  }

  if (selectedColors.length === 0) {
    alert('Please select at least one color');
    submitBtn.disabled = false;
    submitBtn.innerHTML = `<span class="relative z-10 flex items-center gap-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Save Changes</span>`;
    isSubmitting = false;
    return;
  }

  const formData = new FormData();

  // Basic fields
  formData.append('productName', document.getElementById('productName').value.trim());
  formData.append('description', document.getElementById('description').value.trim());
  formData.append('category', document.getElementById('category').value);
  formData.append('regularPrice', document.getElementById('regularPrice').value);
  formData.append('salePrice', document.getElementById('salePrice').value);
  formData.append('status', document.querySelector('[name="status"]').value);
  formData.append('returnPolicy', document.querySelector('[name="returnPolicy"]:checked').value);

  // Colors
  selectedColors.forEach(color => formData.append('color', color));

  // Existing images (only those still in uploadedFiles and marked as existing)
  const existingImages = uploadedFiles
    .filter(file => file && file.existing)
    .map(file => file.name);

  formData.append('existingImages', JSON.stringify(existingImages));

  // New uploaded/cropped images
  uploadedFiles.forEach(file => {
    if (file && !file.existing) {
      formData.append('images', file);
    }
  });

  // Stock inputs (if you have dynamic color/size stock fields)
  document.querySelectorAll('#colorSizeStockSection input[name^="stock_"]').forEach(el => {
    formData.append(el.name, el.value||0);
  });
  formData.append('sizes', 'XS,S,M,L,XL');
    try {
    const response = await fetch(this.action, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    const result = await response.json();

    if (result.success) {
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: result.message || 'Product updated successfully!',
        confirmButtonText: 'OK',
        confirmButtonColor: '#8B7355',
        timer: 3000,
        timerProgressBar: true,
        allowOutsideClick: false,
        showClass: {
          popup: 'animate__animated animate__fadeInDown'
        },
        hideClass: {
          popup: 'animate__animated animate__fadeOutUp'
        }
      }).then(() => {
        window.location.href = '/admin/products';
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Update Failed',
        text: result.message || 'Something went wrong. Please try again.',
        confirmButtonText: 'OK',
        confirmButtonColor: '#dc2626'
      });
    }
  } catch (err) {
    console.error('Submission error:', err);
    Swal.fire({
      icon: 'error',
      title: 'Network Error',
      text: 'Unable to connect to the server. Please check your internet connection and try again.',
      confirmButtonText: 'Retry',
      confirmButtonColor: '#dc2626'
    });
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = `<span class="relative z-10 flex items-center gap-3">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      Save Changes
    </span>`;
    isSubmitting = false;
  }
});

// Initialize
updateImageCount();
</script>
</body>
</html>